import{ACTIONS as U,FILTERS as v,MESSAGES as E,Styles as C}from"./constants.min.js";import{State as i}from"./state.min.js";import{API as P}from"./api.min.js";import{DOM as a,DOMUtils as t}from"./dom.min.js";import{UI as y}from"./ui.min.js";import{Post as R}from"./post.min.js";import{updateNavbar as L}from"./header.min.js";import{checkArgs as w,checkUserAuth as O,validateUsername as M,validateEmail as S,validateImage as _,validatePassword as N}from"./utils.min.js";const T=()=>{a.profileCard.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(!n)return;const o=n.dataset.action;o&&(o===U.PROFILE.FOLLOW&&H(n),o===U.PROFILE.EDIT&&h(n,"edit-profile"))})};async function h(e,r="login",n=null){if(n&&n.preventDefault(),document.querySelector(".modal-overlay"))return;document.documentElement.style.overflow="hidden";const{modalOverlayEl:o,modalTitleEl:c,modalBodyEl:I,saveBtnEl:s,cancelBtnEl:u}=y.createBaseModal(),p={login:{title:"Login",button:"Login"},register:{title:"Register",button:"Register"},"edit-profile":{title:"Edit Profile",button:"Save"}}[r],l=y.createAuthModal(r);I.appendChild(l.profileEditContainerEl),c.textContent=p.title,s.textContent=p.button,r!="login"&&(l.previewImgEl.src=window.getDefaultProfilePicture());let m;r==="edit-profile"&&(m=await V(l,s));const f={login:()=>handleLogin(l,s,u),register:()=>handleRegister(l,s,u),"edit-profile":()=>B(l,m,s,u)},d=()=>{document.documentElement.style.overflow=""};s.addEventListener("click",async()=>{try{await f[r]()}finally{d()}}),u.addEventListener("click",d),l.imageInputEl&&W(l.imageInputEl,l.previewImgEl),a.modalContainer.append(o)}export const handleLogout=async e=>{e.preventDefault(),await P.logout(),i.userIsAuthenticated=!1,i.currentUserId=null,i.currentUsername=null,i.currentUserProfilePicture=window.getDefaultProfilePicture(),L(),R.loadPosts({filter:v.ALL})},handleLogin=async(e,r,n)=>{if(!w({fields:e,loginBtnEl:r,cancelBtnEl:n},"saveProfileEdit"))return;const o=new FormData,c=e.usernameInputEl.value.trim();if(!c){t.addElMessage(e.usernameInputEl,E.ERROR_EMPTY_FIELD);return}o.append("username",c);const I=e.passwordInputEl.value.trim();if(!I){t.addElMessage(e.passwordInputEl,E.ERROR_EMPTY_FIELD);return}if(o.append("password",I),!o.entries().next().done){const s=t.addSpinner(r);try{const{user_id:u,username:p,profile_picture:l}=await P.login(o);i.userIsAuthenticated=!0,i.currentUserId=u,i.currentUsername=p,i.currentUserProfilePicture=l,L(),t.removeSpinner(s),t.closeModal(),L(),R.loadPosts({filter:v.ALL})}catch(u){e.profileEditContainerEl&&t.addElMessage(e.profileEditContainerEl,u.message),console.error(u)}finally{t.removeSpinner(s)}}};const V=async(e,r)=>{if(!O())return;e.previewImgEl.src=a.profilePicture.src,e.usernameInputEl.value=a.profileName.textContent;let n="";const o=t.addSpinner(r);try{n=await k(),e.emailInputEl.value=n}catch{e.emailInputEl.value="",e.emailInputEl.disabled=!0}return t.removeSpinner(o),n};async function k(){const e=a.profileCard.dataset.userId,{email:r}=await P.getUserEmail(e);return r}function W(e,r){!e||!r||e.addEventListener("change",()=>{const n=e.files[0];if(!n||!n.type.startsWith("image/")){r.src=a.profilePicture.src;return}const o=URL.createObjectURL(n);r.src=o,r.onload=()=>URL.revokeObjectURL(o)})}async function B(e,r,n,o){if(!w({fields:e,saveBtnEl:n,cancelBtnEl:o},"saveProfileEdit")||!O())return;const c=new FormData;if(a.profileCard.dataset.userId!=i.currentUserId){t.addElMessage(e.emailInputEl,E.ERROR),console.error(E.profile.errors.dev.INVALID_ID);return}const s=e.usernameInputEl.value.trim(),u=M(s);if(u.error){t.addElMessage(e.usernameInputEl,u.message);return}const p=e.emailInputEl.value.trim().toLowerCase(),l=S(p);if(l.error){t.addElMessage(e.emailInputEl,l.message);return}const m=e.imageInputEl;if(m.files[0]){const f=_(m.files[0]);if(f.error){t.addElMessage(e.imageInputEl,f.message);return}c.append("profile_picture",m.files[0])}if(s!==i.currentUsername&&c.append("username",s),p!=r&&c.append("email",p),!c.entries().next().done){const f=t.addSpinner(n);try{const{success:d,profile_picture:g}=await P.editProfile(c);d&&(s&&(i.currentUsername=s),g&&(i.currentUserProfilePicture=g),t.removeSpinner(f),t.closeModal(),A(i.currentUserId),t.addElMessage(a.profileHeader,E.profile.success.ui.SUCCESS_PROFILE_EDIT,{color:"success"}))}catch(d){e.profileEditContainerEl&&t.addElMessage(e.profileEditContainerEl,d.message),console.error(d)}finally{t.removeSpinner(f),L(),n.disabled=!1,o.disabled=!1}}}function D(e,r){if(!w({el:e,follow:r},"setFollowBtnStyle"))return;const n=r?C.buttons.UNFOLLOW:C.buttons.FOLLOW;e.className=n.className,e.textContent=n.textContent}function G(e){a.profilePicture.src="",a.profileName.textContent=e.username,a.profilePicture.src=e.profile_picture?e.profile_picture:window.getDefaultProfilePicture(),a.followersCount.textContent=`${e.followers}`,a.followingCount.textContent=`${e.following}`,a.profilePostsCount.textContent=e.post_count==null?"0":`${e.post_count}`}async function H(e){if(!w({followBtnEl:e},"followUser")||e.disabled||!O())return;const r=t.addSpinner(e),n=a.profileCard.dataset.userId;try{if(!n||n===i.currentUserId)throw new Error(E.profile.errors.dev.INVALID_DATA);const{follow:o,followers_count:c}=await P.followUser(n);D(e,o),a.followersCount.textContent=c}catch(o){console.error("followUser:",o),t.addElMessage(a.profileHeader,E.profile.errors.ui.ERROR_FOLLOWING_USER)}finally{t.removeSpinner(r)}}function $(e){a.profileCard.dataset.userId=e.id;const r=a.profileCard.querySelector(".btn");r&&r.remove(),i.userIsAuthenticated&&(e.id!=i.currentUserId?F(e.follow):j()),G(e)}function j(){const e=y.createEl(C.buttons.EDIT_PROFILE);a.profileHeader.append(e)}const F=e=>{if(!w({isFollowing:e},"createFollowButton"))return;const r=y.createEl({elType:"button",dataset:{action:U.PROFILE.FOLLOW}});D(r,e),a.profileHeader.append(r)},A=async e=>{if(!w({userId:e},"loadProfile")){t.displayMainMessage(E.profile.errors.ui.ERROR_LOADING_PROFILE);return}i.currentFilter=v.PROFILE,document.body.classList.remove("loaded");try{const r=await P.fetchProfile(e);$(r),R.loadPosts({viewProfileUserId:e,filter:v.PROFILE}),t.updateLayout(),document.body.classList.add("loaded")}catch(r){t.displayMainMessage(E.profile.errors.ui.ERROR_LOADING_PROFILE),console.error("loadProfile:",r)}};export const handleRegister=async(e,r,n)=>{if(!w({fields:e,saveBtnEl:r,cancelBtnEl:n},"saveProfileEdit"))return;const o=new FormData,c=e.usernameInputEl.value.trim(),I=M(c);if(I.error){t.addElMessage(e.usernameInputEl,I.message);return}o.append("username",c);const s=e.emailInputEl.value.trim().toLowerCase(),u=S(s);if(u.error){t.addElMessage(e.emailInputEl,u.message);return}o.append("email",s);const p=e.passwordInputEl.value.trim(),l=e.confirmationInputEl.value.trim(),m=N(p,l);if(m.error){t.addElMessage(e.confirmationInputEl,m.message);return}o.append("password",p),o.append("confirmation",l);const f=e.imageInputEl;if(f.files[0]){const d=_(f.files[0]);if(d.error){t.addElMessage(e.imageInputEl,d.message);return}o.append("profile_picture",f.files[0])}if(!o.entries().next().done){const d=t.addSpinner(r);try{const{user_id:g,username:b,profile_picture:x}=await P.register(o);i.userIsAuthenticated=!0,i.currentUserId=g,i.currentUsername=b,i.currentUserProfilePicture=x,L(),t.removeSpinner(d),t.closeModal(),L(),R.loadPosts({filter:v.ALL})}catch(g){e.profileEditContainerEl&&t.addElMessage(e.profileEditContainerEl,g.message),console.error(g)}finally{t.removeSpinner(d)}}},ProfileUtils={delegate:T,loadProfile:A,createFollowButton:F,showAuthModal:h};