import{ACTIONS as T,FILTERS as R,MESSAGES as d}from"./constants.min.js";import{State as p}from"./state.min.js";import{DOM as I,DOMUtils as E}from"./dom.min.js";import{UI as P}from"./ui.min.js";import{Animations as f}from"./animations.min.js";import{Post as D}from"./post.min.js";import{ProfileUtils as b}from"./profile.min.js";import{Styles as _}from"./constants.min.js";import{checkArgs as h,formatTimestamp as B}from"./utils.min.js";export const getPostData=(e,{wrapper:t=!1,postId:r=!1,userId:s=!1,commentUserId:c=!1,postCard:n=!1,postBody:l=!1,postContent:a=!1,postDate:m=!1,postEditContainer:y=!1,postComments:C=!1,commentInput:S=!1,commentList:g=!1,commentCount:v=!1,commentWrapper:O=!1,commentId:q=!1,commentText:w=!1,commentHeader:L=!1,commentEditContainer:F=!1,commentBody:N=!1}={})=>{const o={},U=t||r||s||n||l||a||m||y||C||S||g||v;let i;if(U&&(i=e.closest("[data-post-id]"),!i))return console.error("Invalid post wrapper. Element:",e),null;const k=w||L||F||N;let u;return k&&(u=e.closest(".comment-wrapper"),!u)?(console.error("Invalid comment. Element:",e),null):(t&&(o.postWrapperEl=i),r&&(o.postId=i.dataset.postId),s&&(o.userId=i.dataset.userId),n&&(o.postCardEl=i.querySelector(".post-card")),l&&(o.postBodyEl=i.querySelector(".post-body")),a&&(o.postContentEl=i.querySelector(".post-content")),m&&(o.postDateEl=i.querySelector(".post-date")),y&&(o.postEditContainerEl=i.querySelector(".post-edit-container")),C&&(o.postCommentsEl=i.querySelector(".post-comments")),S&&(o.commentInputEl=i.querySelector("#comment-input")),g&&(o.commentListEl=i.querySelector(".comment-list")),v&&(o.commentCountEl=i.querySelector(".comment-count")),c&&(o.commentUserId=e.closest("[data-comment-user-id]").dataset.commentUserId),q&&(o.commentId=e.closest("[data-comment-id]").dataset.commentId),O&&(o.commentWrapperEl=e.closest(".comment-wrapper")),w&&(o.commentTextEl=u.querySelector(".comment-text")),L&&(o.commentHeaderEl=u.querySelector(".comment-header")),F&&(o.commentEditContainerEl=u.querySelector(".comment-edit")),N&&(o.commentBodyEl=u.querySelector(".comment-body")),o)};const x=(e,t,r=!1)=>{if(!h({el:e,liked:t},"PostHelpers.setLikeBtnStyle"))return;const s=t?_.buttons.LIKED:_.buttons.UNLIKED;e.className=s.className,e.style.color=t?s.color:"",r&&e.classList.add("disabled-link")};export const validateContent=(e,{originalContent:t=null,maxLength:r=250}={})=>{if(typeof e!="string")return{valid:!1,message:d.post.errors.ui.INVALID_CONTENT};if(t&&t==e)return{valid:!1,message:d.info.NO_CHANGES};const s=e.trim();return s?s.length>r?{valid:!1,message:d.post.errors.ui.EXCEEDS_LIMIT.replace("{max}",r)}:{valid:!0,message:null}:{valid:!1,message:d.post.errors.ui.EMPTY}};const A=(e,t,r,s,c,n)=>{if(!h({postData:e,postUserEl:t,postContentEl:r,postDateEl:s,likeCountEl:c,postProfilePictureEl:n},"PostHelpers.fillPostContent"))return;const l=B(e.timestamp);t.textContent=e.user,r.textContent=e.content,s.textContent=l,c.textContent=e.like_count,n.src=e.profile_picture?e.profile_picture:window.getDefaultProfilePicture()},H=async(e,t=null)=>{const{postEditContainerEl:r,postCardEl:s,postBodyEl:c,postDateEl:n}=getPostData(e,{postEditContainer:!0,postCard:!0,postBody:!0,postDate:!0}),l=r.querySelector(".post-edit-textarea");try{if(!r||!l)throw new Error(d.post.errors.dev.INVALID_DATA);E.removeElMessage(l),await f.play(f.Names.fadeOutShrink,r),r.remove();const a=P.createEl({elType:"h6",className:"post-content"});if(t!==null)a.textContent=t;else{const m=s.dataset.originalContent;a.textContent=m}if(c.insertBefore(a,n),await f.play(f.Names.fadeInExpand,a),s.classList.remove("editing"),t)return a}catch(a){console.error("PostHelpers.cancelEditMode Error: ",a),E.addElMessage(l,d.ERROR)}},W=()=>{let e=`/posts/${p.currentFilter}`;return p.currentFilter===R.PROFILE&&(e+=`?user_id=${p.viewProfileUserId}`),e},$=(e,t)=>{let r=`/posts/${p.currentFilter}/more?post_id=${e}`;return p.currentFilter===R.PROFILE&&(r+=`&user_id=${p.viewProfileUserId}`),r+=`&timestamp=${encodeURIComponent(t)}`,r},V=async e=>{if(p.dropdownLock)return;const{postId:t,postCardEl:r,postBodyEl:s,postDateEl:c,postContentEl:n}=getPostData(e,{postId:!0,postCard:!0,postBody:!0,postDate:!0,postContent:!0});try{if(!t||!r){E.addElMessage(n,d.ERROR),console.error(d.post.errors.dev.INVALID_DATA);return}if(r.classList.contains("editing"))return;r.classList.add("editing");const l=n.textContent;r.dataset.originalContent=l,E.removeElMessage(s);const{textareaEl:a,postEditContainerEl:m}=P.createPostEditLayout();a.value=l,await f.play(f.Names.fadeOutShrink,n),n.remove(),s.insertBefore(m,c),await f.play(f.Names.fadeInExpand,m)}catch(l){console.error("PostHelpers.enterEditMode Error: ",l),E.addElMessage(n,d.ERROR)}},G=async e=>{const t=e.dataset.action===T.POST.USER_PROFILE?"userId":"commentUserId",{[t]:r}=getPostData(e,{[t]:!0});r||(console.error(d.profile.errors.INVALID_ID),E.displayMainMessage(d.profile.errors.ERROR_LOADING_PROFILE)),r!=p.viewProfileUserId&&b.loadProfile(r)},K=()=>{I.newPostForm.dataset.listenerAttached||(I.newPostForm.addEventListener("submit",e=>{e.preventDefault(),D.createPost()}),I.newPostForm.dataset.listenerAttached="true")},X=e=>{const t=document.createDocumentFragment();e.posts.forEach(r=>{t.appendChild(M(r))}),I.postsFeed.appendChild(t)},M=e=>{const{postWrapperEl:t,postHeaderEl:r,postUserEl:s,postContentEl:c,postDateEl:n,likeCountEl:l,likeBtnEl:a,postProfilePictureEl:m,commentCountEl:y}=P.createPostLayout();if(t.dataset.postId=e.id,t.dataset.userId=e.user_id,t.dataset.timestamp=e.timestamp,t.dataset.liked=e.liked?"true":"",A(e,s,c,n,l,m),e.user_is_author){const C=P.createDropdown();r.appendChild(C)}return x(a,e.liked),y.textContent=e.comment_count,t};export const clearPostsFeed=()=>{I.postsFeed.querySelectorAll(".post-wrapper").forEach(t=>{t.remove()})},PostHelpers={getPostData,setLikeBtnStyle:x,validateContent,fillPostContent:A,cancelEditMode:H,buildFetchPostsUrl:W,enterEditMode:V,handleUsernameClick:G,bindNewPostForm:K,createPostsFragment:X,createPostElement:M,buildMorePostsUrl:$};