import{ACTIONS as l,FILTERS as w,MESSAGES as u}from"./constants.min.js";import{State as a}from"./state.min.js";import{API as f}from"./api.min.js";import{DOM as d,DOMUtils as s}from"./dom.min.js";import{PostHelpers as i,clearPostsFeed as h}from"./post-helpers.min.js";import{UI as O}from"./ui.min.js";import{Comment as E}from"./comment.min.js";import{checkArgs as L,checkUserAuth as P,awaitFrame as D}from"./utils.min.js";import{Animations as C}from"./animations.min.js";import{updateNavbar as N}from"./header.min.js";const R=()=>{const e={[l.POST.LIKE]:_,[l.POST.DROPDOWN]:s.toggleDropdown,[l.POST.EDIT]:i.enterEditMode,[l.POST.DELETE]:A,[l.POST.USER_PROFILE]:i.handleUsernameClick,[l.POST.COMMENT_USER_PROFILE]:i.handleUsernameClick,[l.POST.CANCEL_EDIT]:i.cancelEditMode,[l.POST.SAVE_EDIT]:T,[l.POST.COMMENTS]:E.toggleComments,[l.POST.CREATE_COMMENT]:E.createComment,[l.COMMENT.EDIT]:E.enterEditMode,[l.COMMENT.DELETE]:E.showDeleteCommentModal,[l.COMMENT.CANCEL_EDIT]:E.cancelEditMode,[l.COMMENT.SAVE_EDIT]:E.saveEditedComment};d.postsFeed.addEventListener("click",t=>{const o=t.target.closest("[data-action]");if(!o)return;const r=o.dataset.action;r&&e[r](o)})};function A(e){if(document.querySelector(".modal-overlay")||a.dropdownLock||!P())return;const{postWrapperEl:t,postId:o}=i.getPostData(e,{wrapper:!0,postId:!0}),{modalOverlayEl:r,modalTitleEl:n,modalBodyEl:c,saveBtnEl:p}=O.createBaseModal();n.textContent="Confirm Action";const m=O.createEl({elType:"p",className:"modal-message"});m.textContent=u.dom.modal.info.CONFIRM_DELETE,c.append(m),p.textContent="Confirm",p.addEventListener("click",()=>{s.closeModal(),M(o,t)},{once:!0}),d.modalContainer.append(r)}const M=async(e,t)=>{if(!L({postId:e,postWrapperEl:t},"Post.deletePost"))return;const o=s.addSpinner(t);try{await f.deletePost(e),await C.play(C.Names.fadeOutCollapse,o),s.removeSpinner(o),t.remove(),a.postsCount-=1}catch{s.removeSpinner(o),s.addElMessage(t,u.ERROR)}if(a.postsCount===0&&S({viewProfileUserId:a.currentUserId,filter:a.currentFilter}),a.currentFilter==w.PROFILE){const r=Number(d.profilePostsCount.textContent);d.profilePostsCount.textContent=Math.max(0,r-1)}},T=async e=>{if(!P())return;const{postId:t,postEditContainerEl:o,postCardEl:r}=i.getPostData(e,{postId:!0,postEditContainer:!0,postCard:!0}),n=o.querySelector(".post-edit-textarea"),c=s.addSpinner(e);try{if(!t||!n)throw new Error(u.post.errors.dev.INVALID_DATA);const p=n.value.trim(),m=r.dataset.originalContent,g=i.validateContent(p,{originalContent:m});if(!g.valid){s.addElMessage(n,g.message,{color:"info"}),s.removeSpinner(c);return}const v=await f.editPost(t,p);s.removeSpinner(c);const y=await i.cancelEditMode(e,v.content);s.addElMessage(y,u.post.success.UPDATED,{color:"success"})}catch(p){s.removeSpinner(c),s.addElMessage(n,u.post.errors.ui.ERROR_SAVING_POST),console.error("Post.saveEditedPost:",p)}};async function _(e){if(e.disabled||!P())return;e.disabled=!0;const{postWrapperEl:t,postId:o}=i.getPostData(e,{wrapper:!0,postId:!0}),r=t.querySelector(".like-count"),n=+r.textContent,c=t.dataset.liked==="true";try{if(!o||!r)throw new Error(u.post.errors.dev.INVALID_DATA);r.textContent=c?n-1:n+1,i.setLikeBtnStyle(e,!c,!0),delete t.dataset.liked;const{like_count:p,liked:m}=await f.likePost(o);i.setLikeBtnStyle(e,m),t.dataset.liked=m?"true":"",r.textContent=p}catch(p){console.error("handleLikePostClick:",p),s.addElMessage(r,u.post.errors.ui.ERROR_LIKING_POST),r.textContent=c?n-1:n+1,t.dataset.liked=c?"":"true",i.setLikeBtnStyle(e,c)}finally{e.classList.remove("disabled-link"),e.disabled=!1}}const k=async()=>{if(!P())return;const e=s.addSpinner(d.newPostSubmitBtn);try{const t=d.newPostContent.value.trim(),o=i.validateContent(t);if(!o.valid){s.addElMessage(d.newPostContent,o.message,{color:"info"}),s.removeSpinner(e);return}const{postData:r}=await f.createPost(t);if(d.newPostContent.value="",s.addElMessage(d.newPostContent,u.post.success.CREATED,{color:"success"}),a.postsCount==0){S({highlightId:r.id,filter:a.currentFilter});return}a.postsCount+=1;const n=i.createPostElement(r);n.style.height="0",n.style.overflow="hidden",d.postsFeed.prepend(n),await D(),await C.expand(n),n.style.overflow="visible"}catch(t){s.addElMessage(d.newPostContent,u.post.errors.ui.ERROR_CREATING_POST),console.error(t)}finally{s.removeSpinner(e)}},S=async({viewProfileUserId:e=null,highlightId:t=null,filter:o=null}={})=>{if(a.postsLoading)return;e?a.viewProfileUserId=e:a.viewProfileUserId=null,o&&(a.currentFilter=o,N()),a.postsLoading=!0,a.postsCount=0;let r=i.buildFetchPostsUrl();const n=document.getElementById("infinite-scroll-sentinel");n&&(s.cleanObserver(),s.toggleSentinelLoading(!0,n)),h(),s.updateLayout(),await I(r,n),t&&await C.play(C.Names.fadeInExpand,d.postsFeed)},x=async()=>{const e=document.getElementById("infinite-scroll-sentinel"),t=e.previousElementSibling;if(!t||!e)return;s.toggleSentinelLoading(!0,e);const o=t.dataset.timestamp,r=t.dataset.postId;let n=i.buildMorePostsUrl(r,o);a.scrollObserver&&a.scrollObserver.unobserve(e),await I(n,e)},I=async(e,t)=>{try{const o=await f.fetchPosts(e);if(!o.posts||o.posts.length===0){s.displayMainMessage(u.post.errors.ui.NO_POSTS_FOUND,"info"),a.postsLoading=!1;return}a.postsCount+=o.posts.length,a.hasNextPost=o.hasNext,t&&t.remove(),i.createPostsFragment(o),t&&d.postsFeed.append(t),a.hasNextPost&&s.initInfiniteScroll()}catch(o){s.displayMainMessage(u.post.errors.ui.ERROR_LOADING_POSTS),console.error(o)}finally{s.toggleSentinelLoading(!1,t)}};export const Post={delegate:R,deletePost:M,saveEditedPost:T,createPost:k,loadPosts:S,loadMorePosts:x};