import{MESSAGES as c}from"./constants.min.js";import{State as y}from"./state.min.js";import{DOM as M,DOMUtils as r}from"./dom.min.js";import{UI as E}from"./ui.min.js";import{Animations as l}from"./animations.min.js";import{API as C}from"./api.min.js";import{getPostData as u,validateContent as v}from"./post-helpers.min.js";import{checkArgs as g,checkUserAuth as w,formatTimestamp as L,awaitFrame as S,clearElement as I}from"./utils.min.js";function R(e){if(!g({comment:e},"createCommentElement"))return;const{commentWrapperEl:o,commentAvatarEl:t,commentAuthorEl:n,commentTextEl:s,commentTimestampEl:a}=E.createCommentLayout();if(e.user_is_author){const i=E.createDropdown("COMMENT");o.appendChild(i)}const m=L(e.timestamp);return t.src=e.profile_picture?e.profile_picture:window.getDefaultProfilePicture(),s.textContent=e.content,n.textContent=e.user,a.textContent=m,o.dataset.commentUserId=e.user_id,o.dataset.commentId=e.id,o}async function O(e,o){if(!g({commentId:e,commentWrapperEl:o},"deleteComment"))return;const{commentCountEl:t}=u(o,{commentCount:!0}),n=r.addSpinner(o);try{const{commentCount:s}=await C.deleteComment(e);await l.play(l.Names.fadeOutCollapse,n),r.removeSpinner(n),o.remove(),t.textContent=s}catch(s){console.error(s),o&&r.addElMessage(o,c.ERROR),r.removeSpinner(n)}}const A=async e=>{if(e.disabled||!w())return;const{postId:o,commentInputEl:t,commentListEl:n,commentCountEl:s}=u(e,{wrapper:!0,postId:!0,commentInput:!0,commentList:!0,commentCount:!0}),a=r.addSpinner(e);try{if(!o||!t)throw new Error(c.post.errors.dev.INVALID_DATA);const m=t.value.trim(),i=v(m,{maxLength:100});if(!i.valid){r.addElMessage(n,i.message,{color:"info"});return}const{comment:d,commentCount:f}=await C.createComment(o,m),p=R(d);p.style.height="0",p.style.overflow="hidden",n.prepend(p),s.textContent=f,await S(),await l.expand(p),p.style.overflow="visible",t.value=""}catch(m){r.addElMessage(n,c.ERROR,{color:"danger"}),console.error(m)}finally{r.removeSpinner(a)}},D=async e=>{if(!g({commentIconEl:e},"toggleComments"))return;const{postId:o,postCommentsEl:t,commentListEl:n,commentCountEl:s}=u(e,{postId:!0,postComments:!0,commentList:!0,commentCount:!0});if(t.classList.contains("d-none")){const m=r.addSpinner(e);try{if(!o||!t)throw new Error(c.post.errors.dev.INVALID_DATA);const{comments:i}=await C.fetchComments(o);s.textContent=i.length;const d=document.createDocumentFragment();i.forEach(f=>{const p=R(f);p.style.overflow="visible",d.append(p)}),n.append(d)}catch(i){r.addElMessage(n,c.ERROR,{color:"danger"}),console.error(i)}finally{r.removeSpinner(m),t.style.overflow="hidden",t.classList.remove("d-none"),await l.expand(t),t.style.overflow="visible"}}else t.style.overflow="hidden",await l.collapse(t),t.classList.add("d-none"),I(n)},T=e=>{if(document.querySelector(".modal-overlay")||y.dropdownLock||!w())return;const{commentWrapperEl:o,commentId:t}=u(e,{commentWrapper:!0,commentId:!0}),{modalOverlayEl:n,modalFooterEl:s,modalTitleEl:a,saveBtnEl:m,modalBodyEl:i}=E.createBaseModal();a.textContent="Confirm Action";const d=E.createEl({elType:"p",className:"modal-message",textContent:c.dom.modal.info.CONFIRM_DELETE});i.append(d),m.textContent="Confirm",m.addEventListener("click",()=>{r.closeModal(),O(t,o)},{once:!0}),M.modalContainer.append(n)},N=async e=>{if(y.dropdownLock)return;const{commentTextEl:o,commentHeaderEl:t,commentWrapperEl:n}=u(e,{commentText:!0,commentHeader:!0,commentWrapper:!0});if(!t.classList.contains("editing"))try{if(!o||!t||!n){n&&r.addElMessage(n,c.ERROR,{color:"danger"}),console.error(c.ERROR);return}t.classList.add("editing");const s=o.textContent;t.dataset.originalContent=s;const{wrapperEl:a}=E.createCommentEditLayout(s);await l.play(l.Names.fadeOutShrink,o),o.remove(),t.append(a),await l.play(l.Names.fadeInExpand,a)}catch(s){r.addElMessage(n,c.ERROR,{color:"danger"}),console.error(s)}},h=async(e,o=null)=>{const{commentEditContainerEl:t,commentHeaderEl:n,commentWrapperEl:s}=u(e,{commentEditContainer:!0,commentHeader:!0,commentWrapper:!0});try{if(!t)throw new Error(c.ERROR);await l.play(l.Names.fadeOutShrink,t),t.remove();const a=E.createEl({elType:"span",className:"comment-text"});if(o!==null)a.textContent=o;else{const m=n.dataset.originalContent;a.textContent=m}n.append(a),await l.play(l.Names.fadeInExpand,a),n.classList.remove("editing")}catch(a){r.addElMessage(s,c.ERROR,{color:"danger"}),console.error(a)}},b=async e=>{if(!w())return;e.disabled=!0;const{commentId:o,commentEditContainerEl:t,commentHeaderEl:n,commentWrapperEl:s,commentBodyEl:a}=u(e,{commentId:!0,commentEditContainer:!0,commentHeader:!0,commentWrapper:!0,commentBody:!0}),m=t.querySelector(".comment-textarea"),i=r.addSpinner(e);try{if(!o||!m||!s)throw new Error(c.ERROR);const d=m.value.trim(),f=n.dataset.originalContent,p=v(d,{originalContent:f,maxLength:100});if(!p.valid){r.addElMessage(a,p.message,{color:"info",position:"beforeend"}),r.removeSpinner(i);return}const x=await C.editComment(o,d);r.removeSpinner(i),await h(e,x.content),r.addElMessage(a,c.post.success.UPDATED,{color:"success",position:"beforeend"})}catch(d){r.addElMessage(a,c.ERROR,{color:"danger",position:"beforeend"}),r.removeSpinner(i),console.error(d)}finally{e.disabled=!1}};export const Comment={createComment:A,toggleComments:D,showDeleteCommentModal:T,enterEditMode:N,cancelEditMode:h,saveEditedComment:b};